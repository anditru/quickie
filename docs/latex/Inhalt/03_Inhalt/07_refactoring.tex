\chapter{Refactoring}
Refactoring bezeichnet in der Softwareentwicklung Änderungen an den Interna einer Software, um diese verständlicher und änderbarer zu gestalten, ohne ihr sichtbares Verhalten zu ändern. Auch im Zuge dieses Projekts entstanden während der Entwicklung sogenannte Code Smells, also verbesserungswürdige Stellen im Code. Drei dieser Code Smells werden in den nachfolgenden Abschnitten beschrieben und anschließend gezeigt, wie durch Refactoring der Code verbessert wurde. Alle drei dieser Code Smells sind auf dem Stand des Commits \href{https://github.com/anditru/quickie/tree/bb41442c7f1ffbfcd3117cd86a40f7932e543a33}{bb41442c7f1ffbfcd3117cd86a40f7932e543a33} sichtbar.

\section{Code Smells}
\subsection{Duplicated Code} \label{sec:duplicatedCode}
Die Klasse \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfileRepository.java}{\code{JPAProfileRepository}} implementiert unter anderem die Methoden \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfileRepository.java#L40}{\code{persistentAdd}}, \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfileRepository.java#L56}{\code{persistentUpdate}} und \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfileRepository.java#L72}{\code{persistentRemove}} zur Erstellung, Änderung und Löschung von Profiles. Da diese Methoden von der abstrakten Klasse \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/1-quickie-adapters/src/main/java/org/pinkcrazyunicorn/quickie/adapters/persistence/PersistentProfileRepository.java}{\code{PersistentProfileRepository}} geerbt werden, erwarten diese als Argument ein \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/1-quickie-adapters/src/main/java/org/pinkcrazyunicorn/quickie/adapters/persistence/PersistentProfile.java}{\code{PersistentProfile}}. Die konkrete Implementierung \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfileRepository.java}{\code{JPAProfileRepository}} kann jedoch nur Profiles vom Typ \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfile.java}{\code{JPAProfile}}, einer Unterklasse des \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/1-quickie-adapters/src/main/java/org/pinkcrazyunicorn/quickie/adapters/persistence/PersistentProfile.java}{\code{PersistentProfile}}, verarbeiten. Darum muss zu Beginn der Methoden geprüft werden, ob das übergebene Profile den passenden Typ besitzt, sonst wird eine Exception geworfen.

Der hierfür zuständige Code ist in allen drei Methoden identisch, wurde jedoch explizit in jeder der Methoden ausgeschrieben. Hierbei handelt es sich eindeutig um Duplicated Code, einen sehr kritischen Code Smell, der dazu führen würde, dass bei einer Änderung in den Anforderungen an das \code{JPAProfileRepository} die Änderungen ggf. an drei Stellen durchgeführt werden müssten.

\subsection{Large Class}
Die Klasse \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-scraper/src/main/java/org/pinkcrazyunicorn/quickie/plugins/scraper/HensslerScraper.java}{\code{HensslerScraper}} hat eine stark erhöhte Zeilen- und Methodenanzahl im Vergleich zu anderen Klassen des Projektes. In dieser Klasse wird implementiert, wie Daten aus Webseite extrahiert werden und was extrahiert werden soll. Hier ist das Single Responsibility Principle verletzt, da die Klasse sowohl implementiert, wie ein Rezept aus einer Rezeptseite extrahiert wird, aber auch wie alle Rezeptseiten gefunden werden und zugleich dazu jeweils das \enquote{Wie} sowie das \enquote{Was}. Aufgrund dieser Verletzung des Single Responsibility Principles und der großen Menge an Code ist die Klasse sehr unübersichtlich. So wird zum Beispiel in \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-scraper/src/main/java/org/pinkcrazyunicorn/quickie/plugins/scraper/HensslerScraper.java#L22}{Zeile 22} eine Konstante definiert, welche erst über 100 Zeilen später in der Methode \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-scraper/src/main/java/org/pinkcrazyunicorn/quickie/plugins/scraper/HensslerScraper.java#L149}{\code{getRecipeURLs}} verwendet wird. Des Weiteren verwendet diese Methode keine der anderen Methoden der Klasse und auch keine andere Methode der Klasse verwendet diese. Diese Methode trägt zu niedriger Kohäsion in der Klasse bei. Dieser Code Smell sollte behoben werden, indem die Funktionalität in eine weitere Klasse ausgelagert wird.

\subsection{Long Method}
Die Methode \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-scraper/src/main/java/org/pinkcrazyunicorn/quickie/plugins/scraper/HensslerScraper.java#L100}{\code{parseIngredientText}} der Klasse \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-scraper/src/main/java/org/pinkcrazyunicorn/quickie/plugins/scraper/HensslerScraper.java}{\code{HensslerScraper}} ist vergleichsweise lang. Hier sind verschiedene Varianten kombiniert, wie ein Text geparst werden könnte, der eine Ingredient enthält. Da es auf der Webseite sehr viele Varianten für die Beschreibung eines Ingredients gibt, muss bestimmt werden, welche Variante in dem Text vorliegt und dann entsprechend geparst werden. Da in dieser Methode alle Varianten bestimmt und auch geparst werden, ist hier \enquote{Wie-Code} stark mit \enquote{Was-Code} gemischt. Diese Methode ist aufgrund dessen unlesbar. Besser wäre es, einzelne Varianten in Methoden auszulagern und in dieser Methode zu orchestrieren. Es wäre sogar denkbar, diese Funktionalität in eine eigene Klasse auszulagern, um die Funktionalität zu kapseln, da diese Methode keine Abhängigkeiten auf andere Methoden hat und große Komplexität.

\section{Refactoring}
%\subsection{Falsch implementierter Singleton}
%Für die Persistenz der Software wird \ac{JPA} verwendet. \ac{JPA} arbeitet mit sogenannten \code{EntityManager}n, welche den Zugriff auf Datenbankentitäten kapseln. Erzeugt werden diese \code{EntityManager} durch eine \code{EntityManagerFactory}. Da es sich bei dieser um ein relativ großes Objekt handelt, wurde mit der Klasse \code{PersistenceManager} ein lazy Singleton implementiert, welcher sicherstellen sollte, dass stets nur eine \code{EntityManagerFactory} existiert. Allerdings ist die gewählte Implementierung des Singleton nicht threadsicher und stellt in Java auch nicht vollständig sicher, dass nur eine Instanz der \code{PersistenceManagerFactory} existiert.
%
%Aus diesen Gründen wurde beim Refactoring die Klasse \code{PersistenceManager} komplett entfernt und der Singleton statt dessen \enquote{implizit} umgesetzt, in dem in der Main-Klasse des Programms eine Instanz der \code{EntityManagerFactory} zentral erzeugt wird, welche dann in die Repositories injected wird. Diese Variante implementiert das Entwurfsmuster Singleton zwar nicht explizit, stellt jedoch tatsächlich sicher, dass nur eine Instanz der \code{EntityManagerFactory} existiert und ist außerdem threadsicher. Dieses Refactoring kann im Commit \href{https://github.com/anditru/quickie/commit/ab3ffd3a597ec6aee30ace0f75c9ace79617804e}{ab3ffd3a597ec6aee30ace0f75c9ace79617804e} eingesehen werden.

\subsection{Extract Method}
Wie in \autoref{sec:duplicatedCode} beschrieben, ist in der Klasse \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfileRepository.java}{\code{JPAProfileRepository}} doppelter Code vorhanden. Aus diesem Grund wurde hier das Refactoring \enquote{Extract Method} angewendet und somit die Überprüfung des Typs in die Methode \href{https://github.com/anditru/quickie/blob/d39394fa4590c1fd7fadc7974ee37c5416c0fc93/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfileRepository.java#L81}{\code{assertInstanceOfJPARecipe}} ausgelagert. Um die Struktur der Repositories im JPA-Plugin konsistent zu halten, wurde die entsprechende Typüberprüfung im \href{https://github.com/anditru/quickie/blob/master/0-quickie-plugin-jpa/src/main/java/org/pinkcrazyunicorn/quickie/plugins/jpa/JPAProfileRepository.java}{\code{JPARecipeRepository}} ebenfalls in eine separate Methode ausgelagert, obwohl sie hier nur einmal auftritt. Dieses Refactoring kann im Commit \href{https://github.com/anditru/quickie/commit/00a028943c4e6a02b5ad6f14f0268f60c9528e8f}{00a028943c4e6a02b5ad6f14f0268f60c9528e8f} eingesehen werden.

\subsection{Replace Error Code with Exception}
In der Klasse \href{https://github.com/anditru/quickie/blob/bb41442c7f1ffbfcd3117cd86a40f7932e543a33/0-quickie-plugin-scraper/src/main/java/org/pinkcrazyunicorn/quickie/plugins/scraper/HensslerScraper.java}{\code{HensslerScraper}} werden die Webseiten mit den einzelnen Rezepten geparsed. Einige Methoden der Klasse liefern unter Umständen \code{null} als Rückgabewert, wenn das gesamte Rezept bzw. ein einzelner Abschnitt eines Rezepts nicht geparsed werden kann. Zwar werden diese Fälle durch entsprechende Überprüfungen abgefangen, dennoch wird auf diese Weise nicht der Fehlerfall vom Normalfall getrennt. Außerdem kann das Abprüfen eines solchen Fehlerfalls leicht vergessen werden.

Aus diesem Grund wurde hier das Refactoring \enquote{Replace Error Code with Exception} angewendet. Statt \code{null} zurückzugeben wird an den entsprechenden Stellen nun die Exception \href{https://github.com/anditru/quickie/blob/d39394fa4590c1fd7fadc7974ee37c5416c0fc93/0-quickie-plugin-scraper/src/main/java/org/pinkcrazyunicorn/quickie/plugins/scraper/exceptions/FailedToParseRecipe.java}{\code{FailedToParseRecipe}} bzw. \href{https://github.com/anditru/quickie/blob/d39394fa4590c1fd7fadc7974ee37c5416c0fc93/0-quickie-plugin-scraper/src/main/java/org/pinkcrazyunicorn/quickie/plugins/scraper/exceptions/FailedToParseIngredient.java}{\code{FailedToParseIngredient}} geworfen. Auf diese Weise wird sichergestellt, dass die Methoden niemals \code{null} zurückgeben, außerdem werden Entwickler durch den Compiler gezwungen, die beiden Fehlerfälle zu behandeln. Dieses Refactoring kann im Commit \href{https://github.com/anditru/quickie/commit/301bc8fba7e86b8386e09629ab2178e0258b7e78}{301bc8fba7e86b8386e09629ab2178e0258b7e78} eingesehen werden.
